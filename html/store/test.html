<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
<link href="css/showMap.css" rel="stylesheet">
<script src="https://cdn.bootcss.com/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="lib/layer/2.4/layer.js"></script>
<!-- 百度地图api引入 -->
<script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=HHNwksT3c9XuGE9iwPrL0LLgSF0KzQsg"></script>
<script>
    // 打开百度地图
    function openMap(address) {
        var longitude = null; // 经度
        var latitude = null;  // 纬度
        // 弹出地图框
        layer.open({
            title: '地址选择',
            type: 1,
            closeBtn: 1,  // 调试用
            area: ['650px', '550px'], //宽高
            content: '<div id="r-result"><input id="suggestId"  class="form-control searchInput" type="text" placeholder="地址搜索框" /></div> ' +
            '<button class="btn btn-primary confirmBtn">提交定位</button>' +
            '<div id="searchResultPanel"></div>' +
            '<div class="searchTip">请在地图上点击一个合适的点作为门店地址</div>' +
            '<div id="allmap"></div>'
        });
        // 初始化地图：中心位置北京天安门
        var map = new BMap.Map("allmap");  // 创建一个地图对象
        var point = new BMap.Point(116.404, 39.915);  // 根据经纬度设置中心点:天安门
        map.centerAndZoom(point,12);  // 设置中心点和缩放级别，数字越大，显示的范围越小
        map.enableScrollWheelZoom();  // 支持滚轮缩放
        map.addControl(new BMap.NavigationControl());  // 左上角添加平移缩放控件
        map.addControl(new BMap.ScaleControl());  // 左下方显示比例
        // 自动补全搜索
        var ac = new BMap.Autocomplete({    //建立一个自动完成的对象
            "input" : "suggestId",
            "location" : map
        });

        ac.addEventListener("onhighlight", function(e) {  //鼠标放在下拉列表上的事件
            var str = "";
            var _value = e.fromitem.value;
            var value = "";
            if (e.fromitem.index > -1) {
                value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
            }
            str = "FromItem<br />index = " + e.fromitem.index + "<br />value = " + value;

            value = "";
            if (e.toitem.index > -1) {
                _value = e.toitem.value;
                value = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
            }
            str += "<br />ToItem<br />index = " + e.toitem.index + "<br />value = " + value;
            $("#searchResultPanel").html(str);
        });

        var myValue;
        ac.addEventListener("onconfirm", function(e) {    //鼠标点击下拉列表后的事件
            var _value = e.item.value;
            myValue = _value.province +  _value.city +  _value.district +  _value.street +  _value.business;
            $("#searchResultPanel").html("onconfirm<br />index = " + e.item.index + "<br />myValue = " + myValue);
            map.clearOverlays();    //清除地图上所有覆盖物
            function myFun(){
                var pp = local.getResults().getPoi(0).point;    //获取第一个智能搜索的结果
                map.centerAndZoom(pp, 18);
                map.addOverlay(new BMap.Marker(pp));    //添加标注
            }
            var local = new BMap.LocalSearch(map, { //智能搜索
                onSearchComplete: myFun
            });
            local.search(myValue);
        });

        // 如果地址为空
        if (address == "") {
            // 根据ip获取地址：初步定位到城市
            function myFun(result){
                var cityName = result.name;
                map.setCenter(cityName);
            }

            var myCity = new BMap.LocalCity();
            myCity.get(myFun);
        }

        // 根据地址在地图上显示
        var myGeo = new BMap.Geocoder();
        myGeo.getPoint(address, function(point) {
            if (point) {
                map.centerAndZoom(point, 17);
                map.addOverlay(new BMap.Marker(point));    // 标注
                longitude = point.lng;
                latitude = point.lat;
            }
        });

        // 鼠标点击获取地址并添加标记
        map.addEventListener("click", function(e) {
            map.clearOverlays();  // 清空所有覆盖物
            newMarker = new BMap.Marker(e.point);
            map.addOverlay(newMarker);
            var pt = e.point;
            myGeo.getLocation(pt, function(rs) {
                var addComp = rs.addressComponents;
                longitude = pt.lng;
                latitude = pt.lat;
                // alert(addComp.province + addComp.city + addComp.district + addComp.street + addComp.streetNumber);
            });
        });

        // 更新经纬度
        $(".confirmBtn").click(function() {
            $(".longitude").val(longitude);
            $(".latitude").val(latitude);
            layer.closeAll();  // 关闭所有窗口
        });
    }
</script>

<input type="text" disabled class="longitude" placeholder="请点击地图">
<input type="text" disabled class="latitude" placeholder="请点击地图">
<a href="javascript:void(0)" onclick="openMap('湛江市');">地图</a>
</body>
</html>